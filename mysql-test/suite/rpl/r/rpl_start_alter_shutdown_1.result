include/master-slave.inc
[connection master]
connection slave;
SET @old_debug_slave= @@global.debug;
stop slave;
SET GLOBAL slave_parallel_threads=4;
set global slave_parallel_mode=optimistic;
start slave;
connection master;
SET @old_debug_master= @@global.debug;
set global binlog_split_alter=true;
create table t3( a int primary key, b int) engine=innodb;
connection master;
connection slave;
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `a` int(11) NOT NULL,
  `b` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
connection slave;
include/stop_slave.inc
connection master;
SET SESSION debug_dbug="d,start_alter_kill";
alter table t3 add column d int;
ERROR HY000: Lost connection to MySQL server during query
include/rpl_reconnect.inc
set global binlog_split_alter= true;
alter table t3 add column d int;
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `a` int(11) NOT NULL,
  `b` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
connection slave;
include/start_slave.inc
connection master;
connection slave;
show binlog events;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-bin.000001	4	Format_desc	2	256	Server ver: 10.5.0-MariaDB-debug-log, Binlog ver: 4
slave-bin.000001	256	Gtid_list	2	285	[]
slave-bin.000001	285	Binlog_checkpoint	2	328	slave-bin.000001
slave-bin.000001	328	Gtid	1	370	GTID 0-1-1
slave-bin.000001	370	Query	1	493	use `test`; create table t3( a int primary key, b int) engine=innodb
slave-bin.000001	493	Gtid	1	535	GTID 0-1-2
slave-bin.000001	535	Query	1	672	use `test`; /*!100001  alter table t3 add column d int EXECUTE = UNTIL COMMIT 9 */
slave-bin.000001	672	Gtid	1	714	GTID 0-1-3
slave-bin.000001	714	Query	1	851	use `test`; /*!100001  alter table t3 add column d int EXECUTE = UNTIL COMMIT 5 */
slave-bin.000001	851	Gtid	1	893	GTID 0-1-4
slave-bin.000001	893	Query	1	1023	use `test`; alter table t3 add column d int /*!100001 EXECUTE = COMMIT 5 */
connection master;
SET GLOBAL debug_dbug= @old_debug_master;
drop table t3;
set global binlog_split_alter= false;
connection slave;
SET GLOBAL debug_dbug= @old_debug_slave;
stop slave;
SET GLOBAL slave_parallel_threads=0;
set global slave_parallel_mode=conservative;
start slave;
include/rpl_end.inc
